<?php

namespace Controller;

use Core\Session;
use const DIRECTORY_SEPARATOR;

if (!function_exists('sanitize_string')) {
    function sanitize_string($value): string
    {
        if ($value === null) {
            return '';
        }
        if (is_bool($value)) {
            $value = $value ? '1' : '';
        } elseif (!is_scalar($value)) {
            $value = '';
        }
        $value = strip_tags((string)$value);
        $sanitized = preg_replace('/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/u', '', $value);
        if ($sanitized === null) {
            return '';
        }
        return $sanitized;
    }
}

function response($response)
{
    header("Content-Type: application/json; charset=UTF-8;");
    $response = json_encode($response); //, JSON_HEX_TAG|JSON_HEX_AMP|JSON_HEX_QUOT);
    echo $response;
    exit(0);
}



class AjaxCtrl extends AnyCtrl
{
    public function __construct()
    {
        parent::__construct();
        $response = ["response" => ['error' => FALSE, 'errorMsg' => NULL, 'data' => [],],];
        if (isset($_GET['cmd'])) {
            $cmd = \sanitize_string($_GET['cmd']);
            $response = ["response" => ['error' => FALSE, 'errorMsg' => NULL, 'data' => [],],];
			if(strpos($cmd,'-')!=false){
				$tmp = explode('-',$cmd);
				$tmp[1] = ucwords($tmp[1]);
				$cmd = implode($tmp);
			}
            if (!in_array($cmd, ['news', 'configuration'])) {
                $this->checkAjaxToken($response);
            }
            if (!file_exists(__DIR__ . DIRECTORY_SEPARATOR . "Ajax" . DIRECTORY_SEPARATOR . $cmd . ".php")) {
                $response['response']['error'] = TRUE;
                $response['response']['errorMsg'] = "Parameter \"$cmd\" (ajax.php) is not valid in \"cmd\".";
                $response['response']['data'] = [];
                response($response);
            }
            $cmd = '\\Controller\\Ajax\\' . $cmd;
            $dispatcher = new $cmd($response['response']);
            if (method_exists($dispatcher, "dispatch")) {
                $dispatcher->dispatch();
            }
            response($response);
        } else {
            $response['response']['error'] = TRUE;
            $response['response']['errorMsg'] = "Parameter \"cmd\" can not be empty or null.";
            $response['response']['data'] = [];
            response($response);
        }
    }
    function checkAjaxToken(&$response)
    {
        return true;
        if (!isset($_POST['ajaxToken']) || \sanitize_string($_POST['ajaxToken']) != $this->session->getAjaxToken()) {
            $response['ajaxToken'] = NULL;
            $response['response']['error'] = TRUE;
            $response['response']['errorMsg'] = 'Invalid token.';
            response($response);
        }
        return TRUE;
    }
}