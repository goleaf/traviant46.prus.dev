# Communication Tables

This reference captures the four legacy tables that power in-game messaging, reporting, and player notes. It documents their purpose, notable columns, and the game flows that interact with each table so that we can map them to future Laravel models and migrations.

## `mdata` – private and alliance messages
- Stores both direct player messages and alliance-wide broadcasts. Each row links a sender (`uid`) to a recipient (`to_uid`), tracks message state (`viewed`, `archived`, deletion flags), and records delivery metadata such as `autoType` (system message classification) and `isAlliance` (broadcast scope).【F:main_script_dev/include/schema/T4.4.sql†L930-L952】
- Message lifecycle flags are toggled throughout the legacy message controller and model to drive inbox/outbox views, spam reporting, and archival flows.【F:main_script_dev/include/Model/MessageModel.php†L136-L347】
- System clean-up jobs periodically purge old or duplicated messages, relying on `viewed`, `time`, and `md5_checksum` for retention rules.【F:main_script_dev/include/Core/Automation.php†L398-L410】【F:main_script_dev/include/Model/MessageModel.php†L252-L258】

### Key considerations for the redesign
- Replace manual deletion flags with soft deletes or pivot tables for per-user message visibility.
- Introduce foreign keys to `users` (sender/recipient) and `alliances` for alliance broadcasts.
- Normalize `autoType` into an enum or reference table to make system-generated messages explicit.

## `ndata` – battle, trade, and system reports
- Aggregates all report types generated by combats, trades, adventures, and system notifications. The table stores ownership (`uid`), alliance visibility (`aid`), source/destination villages (`kid`, `to_kid`), and serialized payloads (`data`, `bounty`).【F:main_script_dev/include/schema/T4.4.sql†L1153-L1181】
- Report filters and pagination are implemented by toggling `viewed`, `archive`, and `deleted` fields and by querying `type`, `losses`, and `time` ranges within the reports controller/model.【F:main_script_dev/include/Controller/BerichteCtrl.php†L1273-L1510】【F:main_script_dev/include/Model/BerichteModel.php†L14-L113】
- `NoticeHelper` composes the complex JSON-like structures stored in `data` when inserting fresh reports, meaning that any redesign must also address payload normalization.【F:main_script_dev/include/Game/NoticeHelper.php†L95-L105】

### Key considerations for the redesign
- Replace text blobs with structured tables (e.g., `report_events`, `report_units`) and JSON columns where flexibility is still required.
- Add explicit foreign keys to player and village tables to support cascading deletes and analytics.
- Use proper timestamp columns to enable efficient retention policies and archival automation.

## `messages_report` – spam/abuse tickets
- Captures player-submitted spam reports by linking a reporter (`uid`), the accused (`reported_uid`), the underlying message (`message_id`), and the moderation category (`type`).【F:main_script_dev/include/schema/T4.4.sql†L1129-L1143】
- Reports are raised from the legacy AJAX endpoint and surface in the admin "Reported Messages" panel for review and dismissal.【F:main_script_dev/include/Controller/Ajax_old/reportSpamMessage.php†L59-L63】【F:main_script_dev/include/admin/include/Controllers/ReportedMessagesCtrl.php†L29-L73】

### Key considerations for the redesign
- Represent moderation states (open, resolved, dismissed) explicitly instead of deleting rows after review.
- Enforce foreign keys to `messages` and `users` so that moderation dashboards can eager-load related data.
- Audit moderation actions with timestamps and actor tracking for compliance.

## `notes` – private player annotations
- Stores one-to-one notes that players write about other players, keyed by author (`uid`) and target (`to_uid`).【F:main_script_dev/include/schema/T4.4.sql†L1791-L1803】
- The `PlayerNote` model reads or upserts a single note per relationship, allowing the UI to show memo fields in player profiles.【F:main_script_dev/include/Model/PlayerNote.php†L10-L19】

### Key considerations for the redesign
- Move to a unique constraint on (`uid`, `to_uid`) and expose timestamps to show when notes were last updated.
- Store note history or leverage soft deletes so that players can undo accidental deletions.
- Ensure privacy controls are enforced when federating notes across future social features.
