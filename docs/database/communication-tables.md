# Legacy Communication Tables Reference

This document catalogs the two legacy Travian T4.4 communication tables that power in-game messages and battle/system reports. The notes capture each table's responsibility, schema quirks, and the PHP flows that read or mutate the data so we can design Laravel replacements with confidence.

## `mdata` – player and alliance messages
- Stores one record per message linking a sender (`uid`) to a recipient (`to_uid`) along with subject, body, state flags (`viewed`, `archived`, `delete_receiver`, `delete_sender`, `reported`), delivery metadata (`autoType`, `isAlliance`), and an `md5_checksum` used for spam detection. Indexed combinations support inbox queries and full-text search across message content.【F:main_script/include/schema/T4.4.sql†L931-L952】
- The `MessageModel` toggles message lifecycle flags when players read, archive, delete, or recover entries from their inbox/outbox; it also filters ignored senders and respects sitter permissions when building paginated views.【F:main_script/include/Model/MessageModel.php†L133-L326】
- Spam mitigation throttles high-volume senders by counting recent inserts, hashing message bodies, and redirecting offenders, while administrators receive notifications for new support tickets generated via low `uid` special accounts.【F:main_script/include/Model/MessageModel.php†L229-L358】【F:main_script/include/Controller/NachrichtenCtrl.php†L220-L335】
- Automated maintenance jobs purge viewed messages older than two days, underscoring the need for archival policies or soft deletes when porting the feature to Laravel.【F:main_script/include/Core/Automation.php†L400-L427】

## `ndata` – combat, trade, and system reports
- Aggregates every report the game emits, linking rows to owners (`uid`), alliances (`aid`), source/destination villages (`kid`, `to_kid`), and storing serialized payloads (`data`) plus resource haul snapshots (`bounty`). Boolean flags track enforcement status, archival state, deletion, and non-deletable system notices, while secondary indexes power filtered lists by type, losses, and view state.【F:main_script/include/schema/T4.4.sql†L1148-L1176】
- `BerichteModel` manages per-user lifecycle actions—mark read/unread, archive, recover, delete—and provides filtered pagination that mirrors the legacy tabbed UI and recursive views used across the reports controller.【F:main_script/include/Model/BerichteModel.php†L11-L133】
- The `BerichteCtrl` controller wires those model calls into the UI, enforcing sitter permissions, Gold Club features, and multi-tab filters while paginating and rendering overview rows with localized icons, timestamps, and aggregate statistics.【F:main_script/include/Controller/BerichteCtrl.php†L1200-L1400】
- `NoticeHelper` centralizes report insertion by serializing structured payloads, generating private share keys, updating farm list references, and writing into `ndata`, which future migrations should replace with explicit JSON fields or related tables.【F:main_script/include/Game/NoticeHelper.php†L90-L126】
- Nightly automation trims the table by deleting user-owned reports after configurable retention windows and optionally removing low-loss battle reports, highlighting the requirement for deliberate retention strategies in the redesigned schema.【F:main_script/include/Core/Automation.php†L400-L425】
