#!/usr/bin/env bash

set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
cd "$ROOT"

if ! command -v php >/dev/null; then
    echo "[pre-commit] php binary not found; skipping PHP quality checks."
    exit 0
fi

if [ ! -f "vendor/autoload.php" ]; then
    echo "[pre-commit] Composer dependencies are missing; run 'composer install' first."
    exit 1
fi

export DB_CONNECTION="${DB_CONNECTION:-sqlite}"

if [ -x "vendor/bin/pint" ]; then
    echo "[pre-commit] Running Pint..."
    vendor/bin/pint --dirty

    CHANGED_PHP="$(git diff --name-only -- '*.php')"
    if [ -n "$CHANGED_PHP" ]; then
        echo "$CHANGED_PHP" | xargs git add
    fi
fi

if [ -x "vendor/bin/phpstan" ]; then
    echo "[pre-commit] Running Larastan..."
    vendor/bin/phpstan analyse
fi

mapfile -t TEST_FILES < <(git diff --cached --name-only --diff-filter=ACMR -- 'tests/**/*.php')

if [ "${#TEST_FILES[@]}" -gt 0 ] && [ -x "vendor/bin/pest" ]; then
    echo "[pre-commit] Running Pest on touched test files..."
    vendor/bin/pest "${TEST_FILES[@]}"
fi
